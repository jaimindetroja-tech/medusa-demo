# ğŸ—ï¸ System Architecture

## ğŸ“ Component Overview

The product sync system consists of several interconnected components:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MEDUSA FRAMEWORK                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    SCHEDULED JOB                          â”‚  â”‚
â”‚  â”‚              sync-products.ts                             â”‚  â”‚
â”‚  â”‚  â€¢ Cron: "0 0 * * *" (Daily at midnight)                 â”‚  â”‚
â”‚  â”‚  â€¢ Entry point for sync process                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  UTILITY LIBRARIES                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   retry.ts          â”‚  â”‚  batch-processor.ts      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                     â”‚  â”‚                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ fetchWithRetry()  â”‚  â”‚ â€¢ batchGenerator()       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Exponential       â”‚  â”‚ â€¢ Async iterator         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚   backoff           â”‚  â”‚ â€¢ Memory-efficient       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Max 3 retries     â”‚  â”‚ â€¢ Batch size: 15         â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    WORKFLOWS                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ sync-categories.ts  â”‚  â”‚ Medusa Core Workflows    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                     â”‚  â”‚                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ syncCategoriesWF  â”‚  â”‚ â€¢ createProductsWF       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Check existing    â”‚  â”‚ â€¢ updateProductsWF       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Create new        â”‚  â”‚ â€¢ Built-in workflows     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Return map        â”‚  â”‚                          â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  DATA LAYER                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   Query Service     â”‚  â”‚   Database (PostgreSQL)  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                     â”‚  â”‚                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ query.graph()     â”‚  â”‚ â€¢ Products               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Fetch existing    â”‚  â”‚ â€¢ Categories             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚   products          â”‚  â”‚ â€¢ Variants               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Fetch categories  â”‚  â”‚ â€¢ Metadata               â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  DummyJSON API   â”‚
                    â”‚                  â”‚
                    â”‚ â€¢ GET /products  â”‚
                    â”‚ â€¢ Pagination     â”‚
                    â”‚ â€¢ 194 products   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© Component Details

### 1. **Scheduled Job** (`sync-products.ts`)

**Purpose**: Main orchestrator that coordinates the entire sync process

**Responsibilities**:
- Trigger on cron schedule
- Fetch all products from external API
- Sync categories
- Transform data
- Separate creates vs updates
- Process in batches
- Log progress and errors

**Key Functions**:
```typescript
export default async function syncProductsJob(container: MedusaContainer)
```

**Configuration**:
```typescript
export const config = {
    name: "sync-products",
    schedule: "0 0 * * *", // Daily at midnight
}
```

---

### 2. **Retry Utility** (`lib/retry.ts`)

**Purpose**: Handle network failures with exponential backoff

**Architecture**:
```
Request Attempt 1
    â”‚
    â”œâ”€ Success? â†’ Return data
    â”‚
    â””â”€ Failure? â†’ Wait 1000ms
        â”‚
        Request Attempt 2
            â”‚
            â”œâ”€ Success? â†’ Return data
            â”‚
            â””â”€ Failure? â†’ Wait 2000ms
                â”‚
                Request Attempt 3
                    â”‚
                    â”œâ”€ Success? â†’ Return data
                    â”‚
                    â””â”€ Failure? â†’ Wait 4000ms
                        â”‚
                        Request Attempt 4
                            â”‚
                            â”œâ”€ Success? â†’ Return data
                            â”‚
                            â””â”€ Failure? â†’ Throw error
```

**Key Function**:
```typescript
async function fetchWithRetry<T>(
    url: string,
    options?: RetryOptions
): Promise<T>
```

**Configuration**:
```typescript
{
    maxRetries: 3,              // Total attempts: 4 (1 initial + 3 retries)
    initialDelayMs: 1000,       // Start with 1 second
    maxDelayMs: 30000,          // Cap at 30 seconds
    backoffMultiplier: 2        // Double delay each time
}
```

**Exponential Backoff Formula**:
```
delay = min(initialDelay * (multiplier ^ attempt), maxDelay)

Attempt 1: min(1000 * 2^0, 30000) = 1000ms
Attempt 2: min(1000 * 2^1, 30000) = 2000ms
Attempt 3: min(1000 * 2^2, 30000) = 4000ms
Attempt 4: min(1000 * 2^3, 30000) = 8000ms
```

---

### 3. **Batch Processor** (`lib/batch-processor.ts`)

**Purpose**: Process large arrays in memory-efficient batches

**Architecture**:
```
Input: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17]
Batch Size: 5

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Async Generator                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Yield 1: [1, 2, 3, 4, 5]                              â”‚
â”‚           â†“ Process batch                               â”‚
â”‚  Yield 2: [6, 7, 8, 9, 10]                             â”‚
â”‚           â†“ Process batch                               â”‚
â”‚  Yield 3: [11, 12, 13, 14, 15]                         â”‚
â”‚           â†“ Process batch                               â”‚
â”‚  Yield 4: [16, 17]                                     â”‚
â”‚           â†“ Process batch                               â”‚
â”‚  Done                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Function**:
```typescript
async function* batchGenerator<T>(
    items: T[],
    batchSize: number
): AsyncGenerator<T[], void, unknown>
```

**Benefits**:
- âœ… Prevents memory spikes
- âœ… Allows progressive processing
- âœ… Better error isolation (one batch fails, others continue)
- âœ… Easier to track progress

---

### 4. **Category Sync Workflow** (`workflows/sync-categories.ts`)

**Purpose**: Sync product categories from external API to Medusa

**Architecture**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              syncCategoriesWorkflow                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Input: { categories: CategoryInput[] }                â”‚
â”‚         [{ name: "beauty", slug: "beauty" }, ...]       â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚         syncCategoriesStep                    â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â”‚  1. Query existing categories                â”‚     â”‚
â”‚  â”‚     â†“                                         â”‚     â”‚
â”‚  â”‚  2. Build existing map (handle â†’ id)         â”‚     â”‚
â”‚  â”‚     â†“                                         â”‚     â”‚
â”‚  â”‚  3. Filter: Which are new?                   â”‚     â”‚
â”‚  â”‚     â†“                                         â”‚     â”‚
â”‚  â”‚  4. Create new categories                    â”‚     â”‚
â”‚  â”‚     (using createProductCategoriesWorkflow)  â”‚     â”‚
â”‚  â”‚     â†“                                         â”‚     â”‚
â”‚  â”‚  5. Update map with new IDs                  â”‚     â”‚
â”‚  â”‚     â†“                                         â”‚     â”‚
â”‚  â”‚  6. Return result                            â”‚     â”‚
â”‚  â”‚                                               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                         â”‚
â”‚  Output: {                                              â”‚
â”‚    created: number,                                     â”‚
â”‚    existing: number,                                    â”‚
â”‚    categoryMap: Record<string, string>                  â”‚
â”‚  }                                                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Compensation (Rollback)**:
If the workflow fails, it automatically deletes any categories created during this run.

---

### 5. **Medusa Core Workflows**

**Purpose**: Built-in Medusa workflows for product operations

#### `createProductsWorkflow`
```typescript
import { createProductsWorkflow } from "@medusajs/medusa/core-flows"

await createProductsWorkflow(container).run({
    input: { products: [...] }
})
```

**What it does**:
- Validates product data
- Creates products in database
- Creates variants
- Sets prices
- Uploads images (if applicable)
- Handles transactions
- Automatic rollback on error

#### `updateProductsWorkflow`
```typescript
import { updateProductsWorkflow } from "@medusajs/medusa/core-flows"

await updateProductsWorkflow(container).run({
    input: { products: [{ id: "...", data: {...} }] }
})
```

**What it does**:
- Validates update data
- Updates product fields
- Handles variant updates
- Manages price changes
- Handles transactions
- Automatic rollback on error

---

## ğŸ”„ Data Flow Architecture

### Pagination Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              fetchAllProducts()                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Initialize:                                             â”‚
â”‚  â€¢ allProducts = []                                      â”‚
â”‚  â€¢ skip = 0                                              â”‚
â”‚  â€¢ hasMore = true                                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  WHILE hasMore                                 â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚  1. Build URL:                           â”‚  â”‚     â”‚
â”‚  â”‚  â”‚     ?limit=30&skip={skip}                â”‚  â”‚     â”‚
â”‚  â”‚  â”‚                                          â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  2. Fetch with retry:                    â”‚  â”‚     â”‚
â”‚  â”‚  â”‚     response = fetchWithRetry(url)       â”‚  â”‚     â”‚
â”‚  â”‚  â”‚                                          â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  3. Add to collection:                   â”‚  â”‚     â”‚
â”‚  â”‚  â”‚     allProducts.push(...response.products)â”‚ â”‚     â”‚
â”‚  â”‚  â”‚                                          â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  4. Update pagination:                   â”‚  â”‚     â”‚
â”‚  â”‚  â”‚     skip += 30                           â”‚  â”‚     â”‚
â”‚  â”‚  â”‚     hasMore = (allProducts.length < total)â”‚ â”‚     â”‚
â”‚  â”‚  â”‚                                          â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  5. Log progress                         â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â”‚  Return: allProducts (194 items)                         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Transformation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           mapToMedusaFormat(product)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Input: DummyJSONProduct                                 â”‚
â”‚  {                                                       â”‚
â”‚    id: 1,                                                â”‚
â”‚    title: "iPhone 9",                                    â”‚
â”‚    price: 549,                                           â”‚
â”‚    category: "smartphones",                              â”‚
â”‚    ...                                                   â”‚
â”‚  }                                                       â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Transformations:                              â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  1. Generate handle:                           â”‚     â”‚
â”‚  â”‚     "iPhone 9" â†’ "iphone-9"                    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  2. Convert price to cents:                    â”‚     â”‚
â”‚  â”‚     549 â†’ 54900                                â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  3. Wrap images in objects:                    â”‚     â”‚
â”‚  â”‚     ["url1", "url2"] â†’ [{url:"url1"}, ...]     â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  4. Create default variant:                    â”‚     â”‚
â”‚  â”‚     { title: "Default", prices: [...] }        â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  5. Store external data in metadata:           â”‚     â”‚
â”‚  â”‚     { external_id: "1", category: "..." }      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â”‚  Output: MedusaProductInput                              â”‚
â”‚  {                                                       â”‚
â”‚    title: "iPhone 9",                                    â”‚
â”‚    handle: "iphone-9",                                   â”‚
â”‚    variants: [{...}],                                    â”‚
â”‚    metadata: {...},                                      â”‚
â”‚    ...                                                   â”‚
â”‚  }                                                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Idempotency Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Idempotency Check (Prevent Duplicates)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  For each external product:                              â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  1. Get external_id from product               â”‚     â”‚
â”‚  â”‚     external_id = "1"                          â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  2. Check if exists in Medusa                  â”‚     â”‚
â”‚  â”‚     existing = existingProductMap.get("1")     â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚  3. Decision:                                  â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚     â”‚
â”‚  â”‚     â”‚  Exists?    â”‚                            â”‚     â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                            â”‚     â”‚
â”‚  â”‚            â”‚                                   â”‚     â”‚
â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                             â”‚     â”‚
â”‚  â”‚      â”‚           â”‚                             â”‚     â”‚
â”‚  â”‚     YES         NO                             â”‚     â”‚
â”‚  â”‚      â”‚           â”‚                             â”‚     â”‚
â”‚  â”‚      â–¼           â–¼                             â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚     â”‚
â”‚  â”‚  â”‚UPDATE â”‚  â”‚CREATE  â”‚                         â”‚     â”‚
â”‚  â”‚  â”‚ list  â”‚  â”‚ list   â”‚                         â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚     â”‚
â”‚  â”‚      â”‚           â”‚                             â”‚     â”‚
â”‚  â”‚      â”‚           â””â”€ Ensure unique handle       â”‚     â”‚
â”‚  â”‚      â”‚           â””â”€ Link to category           â”‚     â”‚
â”‚  â”‚      â”‚                                         â”‚     â”‚
â”‚  â”‚      â””â”€ Keep existing handle                   â”‚     â”‚
â”‚  â”‚      â””â”€ Update other fields                    â”‚     â”‚
â”‚  â”‚                                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â”‚  Result:                                                 â”‚
â”‚  â€¢ productsToCreate: MedusaProductInput[]                â”‚
â”‚  â€¢ productsToUpdate: { id, data }[]                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Design Patterns Used

### 1. **Async Generator Pattern**
Used in `batchGenerator()` for memory-efficient iteration

### 2. **Retry Pattern with Exponential Backoff**
Used in `fetchWithRetry()` for resilient network requests

### 3. **Workflow Pattern**
Used in Medusa workflows for transactional operations with automatic rollback

### 4. **Map-Reduce Pattern**
Used for transforming and categorizing products

### 5. **Idempotent Operations**
Ensures safe re-execution without side effects

---

**Next**: [03-data-flow.md](./03-data-flow.md) - Detailed data flow diagrams
